<!DOCTYPE html>
<html>
<head>
<title>El Lokal Bilder Gallerie</title>
<link rel="stylesheet" href="./styleEllokal.css">
<meta name="robots" content="noindex,nofollow,nosnippet,noimageindex"/>
<script type = "text/javascript"
	src = "http://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js">
</script>
<script type = "text/javascript" language = "javascript">
	function DisplayRanklist( jd, startindex, nofranks, mode) {
		if (jd.error)
		{
			alert( "Error: " + jd.error );
			$('#completeimg').hide();
			$('#ranklist').hide();
		}
		else if (0 < jd.result.length)
		{
			if (startindex > 0) {
				$('#searchprev').show();
			}
			else {
				$('#searchprev').hide();
			}
			$('#searchnext').hide();
			if (nofranks+1 == jd.result.length) {
				jd.result.pop();
				$('#searchnext').show();
			}
			else
			{
				$('#searchnext').hide();
			}
			if (mode == 0) {
				var ranklist = "";
				$.each( jd.result, function( i, obj) {
					ranklist += '<div id="rank"><div id="thumbnail"><img alt="Thumbnail" src="data:image/png;base64,' + obj.thumbnail + '"/></div><div id="prop"><ul><li><div id="title">' + obj.title + '</div></li><li><div id="id">' + obj.filename + '</div></li><li><div id="date">' + obj.eventdate + '</div></li><li><div id="dimension">' + obj.width + ' x ' + obj.length + "</div></li></ul>\n</div>\n</div>\n</div>\n";
				});
				$('#ranklist').html( ranklist);
				$('#completeimg').hide();
				$('#ranklist').show();
				
			}
			else if (mode == 1)
			{
				obj = jd.result[0];
				document.getElementById("image").src = "data:image/png;base64,'" + obj.image + "'";
				document.getElementById("imgtitle").value = obj.title;
				document.getElementById("imgid").value = obj.filename;
				document.getElementById("imgdate").value = obj.eventdate;
				document.getElementById("imgdimension").value = obj.width + ' x ' + obj.length;
				$('#ranklist').hide();
				$('#completeimg').show();
			}
		}
		else
		{
			$('#completeimg').hide();
			$('#searchnext').hide();
			if (startindex == 0)
			{
				$('#ranklist').html('<div id="message">No result found</div>');
				$('#searchprev').hide();
			}
			else
			{
				$('#ranklist').html('<div id="message">No more result found</div>');
				$('#searchprev').show();
			}
		}
	}
	function SearchQuery( text, startindex, nofranks, searchmode) {
		if (searchmode == 1)
		{
			nofranks = 1
		}
		$.getJSON( "http://127.0.0.1/ellokalQuery.php",
		{
			q: text,
			i: startindex,
			n: nofranks+1,
			m: searchmode
		},
		function(jd) {
			DisplayRanklist( jd, startindex, nofranks, searchmode) 
			document.getElementById("startindex").value = startindex;
			document.getElementById("nofranks").value = nofranks;
			document.getElementById("searchtext").value = text;
			document.getElementById("searchmode").value = searchmode;
		})
		.fail(function(jqXHR, status, error){
			 alert( "Error (status " + status + "): " + error );
		})
	}
	function DidYouMeanQuery( text) {
		$.getJSON( "http://127.0.0.1/ellokalDym.php",
		{
			q: text,
			n: 20
		},
		function(jd) {
			if (jd.error)
			{
				alert( "Error: " + jd.error );
			}
			else
			{
				$('#DidYouMeanList').html('');
				$.each( jd.result, function( i, obj) {
					$('#DidYouMeanList').append('<div id="DidYouMeanElem" class="dymelem" tabindex="0">' + obj + '</div>');
				});
				if ( jd.result.length == 0 ) {
					$('#DidYouMeanList').hide();
				}
			}
		})
		.fail(function(jqXHR, status, error){
			 alert( "Error (status " + status + "): " + error );
		})
	}
	var delayTimer;
	function submitDidYouMeanQuery() {
		clearTimeout(delayTimer);
		delayTimer = setTimeout(function() {
			DidYouMeanQuery( $('#searchtext').val());
			$('#DidYouMeanList').show();
		}, 400);
	}
	$(function() {
		$("#searchsubmit").click(function(jd) {
			var nof = parseInt( $('#nofranks').val());
			var searchmode = parseInt( $('#searchmode').val());
			var text = $('#searchtext').val();
			$('#DidYouMeanList').hide();
			SearchQuery( text, 0, nof, searchmode);
		});
		$("#searchprev").click(function(jd){
			var nof = parseInt( $('#nofranks').val());
			var idx = parseInt( $('#startindex').val()) - nof;
			if (idx < 0) {
				idx = 0;
			}
			var searchmode = parseInt( $('#searchmode').val());
			var text = $('#searchtext').val();
			$('#DidYouMeanList').hide();
			SearchQuery( text, idx, nof, searchmode);
		});
		$("#searchnext").click(function(jd){
			var nof = parseInt( $('#nofranks').val());
			var idx = parseInt( $('#startindex').val()) + nof;
			var searchmode = parseInt( $('#searchmode').val());
			var text = $('#searchtext').val();
			$('#DidYouMeanList').hide();
			SearchQuery( text, idx, nof, searchmode);
		});
		$("#fullscreen").click(function(jd) {
			var searchmode = parseInt( $('#searchmode').val());
			var nof = parseInt( $('#nofranks').val());
			if (searchmode == 0) {
				searchmode = 1;
				nof = 1;
			}
			else
			{
				searchmode = 0;
				nof = 4;
			}
			document.getElementById("searchmode").value = searchmode;
			document.getElementById("nofranks").value = nof;
			var idx = parseInt( $('#startindex').val());
			var text = $('#searchtext').val();
			$('#DidYouMeanList').hide();
			SearchQuery( text, idx, nof, searchmode);
		});
		$('#searchtext').bind('keydown', function search(event) {
			if(event.keyCode == 13/*ENTER*/) {
				var nof = parseInt( $('#nofranks').val());
				var searchmode = parseInt( $('#searchmode').val());
				var text = $('#searchtext').val();
				$('#DidYouMeanList').hide();
				SearchQuery( text, 0, nof, searchmode);
			}
		});
		$('#DidYouMeanList').bind('keydown', function search(event) {
			if(event.keyCode == 13/*ENTER*/) {
				var nof = parseInt( $('#nofranks').val());
				var searchmode = parseInt( $('#searchmode').val());
				$('#DidYouMeanList').hide();
				SearchQuery( $(event.target).text, 0, nof, searchmode);
			}
		});
		$('#searchtext').bind('input', function() {
			submitDidYouMeanQuery( $('#searchtext').val());
		});
		window.onclick = function(event) {
			if (event.target.matches('.dymelem')) {
				var nof = parseInt( $('#nofranks').val());
				var searchmode = parseInt( $('#searchmode').val());
				$('#DidYouMeanList').hide();
				SearchQuery( $(event.target).text(), 0, nof, searchmode);
			}
			else {
				$('#DidYouMeanList').hide();
			}
		}
	});
</script>
</head>
<body>
<div id="content">
<div id="searchfield">
	<input type = "text" id = "searchtext" tabindex="0"/>
	<input type = "button" id = "searchsubmit" tabindex="-1"/>
	<input type = "button" id = "searchnext" tabindex="-1"/>
	<input type = "button" id = "searchprev" tabindex="-1"/>
	<input type = "button" id = "fullscreen" tabindex="0"/>
	<input type = "hidden" id = "searchmode" value="0" tabindex="-1"/>
	<input type = "hidden" id = "startindex" value="0" tabindex="-1"/>
	<input type = "hidden" id = "nofranks" value="4" tabindex="-1"/>
	<div id="DidYouMean">
		<div id="DidYouMeanList"></div>
	</div>
</div>
<div id="searchresult">
	<div id="ranklist"></div>
</div>
<div id="completeimg">
	<div id="imgprop">
		<div id="imgtitle"></div>
		<div id="imgid"></div>
		<div id="imgdate"></div>
		<div id="imgdimension"></div>
	</div>
	<div id="imageframe"><img id="image" alt="CompleteImage" src=""/></div>
</div>
</div>
</body>
</html>
