<!DOCTYPE html>
<html>
<head>
<title>El Lokal Bilder Gallerie</title>
<link rel="stylesheet" href="./styleEllokal.css">
<script type = "text/javascript"
	src = "http://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js">
</script>
<script type = "text/javascript" language = "javascript">
	function SearchQuery( text, startindex, nofranks) {
		$.getJSON( "http://127.0.0.1/ellokalQuery.php",
		{
			q: text,
			i: startindex,
			n: nofranks
		},
		function(jd) {
			if (jd.error)
			{
				alert( "Error: " + jd.error );
			}
			else if (0 < jd.result.length)
			{
				if (startindex > 0) {
					$('#searchprev').show();
				}
				else {
					$('#searchprev').hide();
				}
				$('#searchnext').hide();
				if (nofranks == jd.result.length) {
					$('#searchnext').show();
				}
				else
				{
					$('#searchnext').hide();
				}
				$('#ranklist').html('');
				$.each( jd.result, function( i, obj) {
					$('#ranklist').append('<div id="rank">');
					$('#ranklist').append('<div id="thumbnail"><img alt="Thumbnail" src="data:image/png;base64,' + obj.thumbnail + '"/></div>');
					$('#ranklist').append('<div id="prop">');
					$('#ranklist').append('<ul>');
					$('#ranklist').append('<li><div id="title">' + obj.title + '</div></li>');
					$('#ranklist').append('<li><div id="id">' + obj.filename + '</div></li>');
					$('#ranklist').append('<li><div id="date">' + obj.insertdate + '</div></li>');
					$('#ranklist').append('<li><div id="dimension">' + obj.width + ' x ' + obj.length + '</div></li>');
					$('#ranklist').append("</ul>\n");
					$('#ranklist').append("</div>\n");
					$('#ranklist').append("</div>\n");
				});
			}
			else
			{
				$('#searchnext').hide();
				if (startindex == 0)
				{
					$('#ranklist').html('<div id="message">No result found</div>');
					$('#searchprev').hide();
				}
				else
				{
					$('#ranklist').html('<div id="message">No more result found</div>');
					$('#searchprev').show();
				}
			}
			document.getElementById("startindex").value = startindex;
			document.getElementById("nofranks").value = nofranks;
			document.getElementById("searchtext").value = text;
		})
		.fail(function(jqXHR, status, error){
			 alert( "Error (status " + status + "): " + error );
		})
	}
	function DidYouMeanQuery( text) {
		$.getJSON( "http://127.0.0.1/ellokalDym.php",
		{
			q: text,
			n: 20
		},
		function(jd) {
			if (jd.error)
			{
				alert( "Error: " + jd.error );
			}
			else
			{
				$('#DidYouMeanList').html('');
				$.each( jd.result, function( i, obj) {
					$('#DidYouMeanList').append('<div id="DidYouMeanElem" class="dymelem" tabindex="0">' + obj + '</div>');
				});
				if ( jd.result.length == 0 ) {
					$('#DidYouMeanList').hide();
				}
			}
		})
		.fail(function(jqXHR, status, error){
			 alert( "Error (status " + status + "): " + error );
		})
	}
	var delayTimer;
	function submitDidYouMeanQuery() {
		clearTimeout(delayTimer);
		delayTimer = setTimeout(function() {
			DidYouMeanQuery( $('#searchtext').val());
			$('#DidYouMeanList').show();
		}, 400);
	}
	$(function() {
		$("#searchsubmit").click(function(jd){
			var nof = parseInt( $('#nofranks').val(), 10);
			SearchQuery( $('#searchtext').val(), 0, nof);
			$('#DidYouMeanList').hide();
		});
		$("#searchprev").click(function(jd){
			var nof = parseInt( $('#nofranks').val(), 10);
			var idx = parseInt( $('#startindex').val(), 10) - nof;
			if (idx < 0) {
				idx = 0;
			}
			$('#DidYouMeanList').hide();
			SearchQuery( $('#searchtext').val(), idx, nof);
		});
		$("#searchnext").click(function(jd){
			var nof = parseInt( $('#nofranks').val(), 10);
			var idx = parseInt( $('#startindex').val(), 10) + nof;
			$('#DidYouMeanList').hide();
			SearchQuery( $('#searchtext').val(), idx, nof);
		});
		$('#searchtext').bind('keydown', function search(event) {
			if(event.keyCode == 13/*ENTER*/) {
				var nof = parseInt( $('#nofranks').val(), 10);
				$('#DidYouMeanList').hide();
				SearchQuery( $('#searchtext').val(), 0, nof);
			}
		});
		$('#DidYouMeanList').bind('keydown', function search(event) {
			if(event.keyCode == 13/*ENTER*/) {
				var nof = parseInt( $('#nofranks').val(), 10);
				$('#DidYouMeanList').hide();
				SearchQuery( $(event.target).text(), 0, nof);
			}
		});
		$('#searchtext').bind('input', function() {
			submitDidYouMeanQuery( $('#searchtext').val());
		});
		window.onclick = function(event) {
			if (event.target.matches('.dymelem')) {
				var nof = parseInt( $('#nofranks').val(), 10);
				$('#DidYouMeanList').hide();
				SearchQuery( $(event.target).text(), 0, nof);
			}
			else {
				$('#DidYouMeanList').hide();
			}
		}
	});
</script>
</head>
<body>
<div id="content">
<div id="searchfield">
	<input type = "text" id = "searchtext" tabindex="0"/>
	<input type = "button" id = "searchsubmit" tabindex="-1"/>
	<input type = "button" id = "searchnext" tabindex="-1"/>
	<input type = "button" id = "searchprev" tabindex="-1"/>
	<input type = "hidden" id = "startindex" value="0" tabindex="-1"/>
	<input type = "hidden" id = "nofranks" value="4" tabindex="-1"/>
	<div id="DidYouMean">
		<div id="DidYouMeanList"></div>
	</div>
</div>
<div id="searchresult">
	<div id="ranklist"></div>
</div>
</div>
</body>
</html>
