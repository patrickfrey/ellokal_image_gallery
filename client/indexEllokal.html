<!DOCTYPE html>
<html>
<head>
<title>El Lokal Bilder Gallerie</title>
<link rel="stylesheet" href="./styleEllokal.css">
<meta name="robots" content="noindex,nofollow,nosnippet,noimageindex"/>
<script type = "text/javascript"
	src = "http://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js">
</script>
<script type = "text/javascript" language = "javascript">
	var g_searchmode=0;
	var g_startindex=0;
	var g_nofranks=4;
	var g_query="";

	function DisplayRanklist( jd, startindex, nofranks, mode) {
		if (jd.error)
		{
			alert( "Error: " + jd.error );
		}
		else if (0 < jd.result.length)
		{
			if (startindex > 0) {
				$('#searchprev').show();
			}
			else {
				$('#searchprev').hide();
			}
			$('#searchnext').hide();
			if (nofranks+1 == jd.result.length) {
				jd.result.pop();
				$('#searchnext').show();
			}
			else
			{
				$('#searchnext').hide();
			}
			$('#ranklist').hide();
			var ranklist = "";
			if (mode == 0) {
				var ranklist = "";
				$.each( jd.result, function( i, obj) {
					ranklist += '<div id="rank"><div id="thumbnail"><img alt="Thumbnail" src="data:image/png;base64,' + obj.thumbnail + '"/></div><div id="prop"><ul><li><div id="title">' + obj.title + '</div></li><li><div id="id">' + obj.filename + '</div></li><li><div id="date">' + obj.eventdate + '</div></li><li><div id="dimension">' + obj.width + ' x ' + obj.length + "</div></li></ul>\n</div>\n</div>\n</div>\n";
				});
			}
			else if (mode == 1)
			{
				obj = jd.result[0];
				ranklist = '<div id="imgprop"><div id="imgtitle">' + obj.title + '</div><div id="imgid">' + obj.filename + '</div><div id="imgdate">' + obj.eventdate + '</div><div id="imgdimension">' + obj.width + ' x ' + obj.length + "</div></div>\n" + '<div id="rank"><div id="bigimage"><img alt="Thumbnail" src="data:image/png;base64,' + obj.image + '"/></div>' + "</div>\n</div>\n";
			}
			else if (mode == 2)
			{
				var ranklist = "";
				$.each( jd.result, function( i, obj) {
					ranklist += '<div id="rank"><div id="concertdate">' + obj.date + '</div><div id="concerttitle">' + obj.title + '</div><div id="concertdescription">';
					if (obj.description != null) {
						ranklist += obj.description;
					}
					ranklist += "</div>\n</div>\n";
				});
			}
			$('#ranklist').html( ranklist);
			$('#ranklist').ready( function() {
				$('#ranklist').show();
			});
		}
		else
		{
			$('#searchnext').hide();
			if (startindex == 0)
			{
				$('#ranklist').html('<div id="message">No result found</div>');
				$('#searchprev').hide();
			}
			else
			{
				$('#ranklist').html('<div id="message">No more result found</div>');
				$('#searchprev').show();
			}
		}
	}
	function SearchQuery( text, startindex, nofranks, searchmode) {
		if (searchmode == 1)
		{
			nofranks = 1
		}
		$.getJSON( "http://127.0.0.1/ellokalQuery.php",
		{
			q: text,
			i: startindex,
			n: nofranks+1,
			m: searchmode
		},
		function(jd) {
			DisplayRanklist( jd, startindex, nofranks, searchmode) 
			g_startindex = startindex;
			g_nofranks = nofranks;
			document.getElementById("searchtext").value = text;
			g_searchmode = searchmode;
		})
		.fail(function(jqXHR, status, error){
			 alert( "Error (status " + status + "): " + error );
		})
	}
	function DidYouMeanQuery( text) {
		$.getJSON( "http://127.0.0.1/ellokalDym.php",
		{
			q: text,
			n: 20
		},
		function(jd) {
			if (jd.error)
			{
				alert( "Error: " + jd.error );
			}
			else
			{
				$('#DidYouMeanList').html('');
				$.each( jd.result, function( i, obj) {
					$('#DidYouMeanList').append('<div id="DidYouMeanElem" class="dymelem" tabindex="0">' + obj + '</div>');
				});
				if ( jd.result.length == 0 ) {
					$('#DidYouMeanList').hide();
				}
			}
		})
		.fail(function(jqXHR, status, error){
			 alert( "Error (status " + status + "): " + error );
		})
	}
	var delayTimer;
	function submitDidYouMeanQuery() {
		clearTimeout(delayTimer);
		delayTimer = setTimeout( function() {
			DidYouMeanQuery( $('#searchtext').val());
			$('#DidYouMeanList').show();
		}, 400);
	}
	$(function() {
		$("#searchsubmit").click(function(jd) {
			$('#DidYouMeanList').hide();
			g_query = $('#searchtext').val();
			SearchQuery( g_query, 0, g_nofranks, g_searchmode);
		});
		$("#searchprev").click(function(jd){
			var idx = g_startindex - g_nofranks;
			if (idx < 0) {
				idx = 0;
			}
			$('#DidYouMeanList').hide();
			SearchQuery( $('#searchtext').val(), idx, g_nofranks, g_searchmode);
		});
		$("#searchnext").click(function(jd){
			var idx = g_startindex + g_nofranks;
			$('#DidYouMeanList').hide();
			SearchQuery( $('#searchtext').val(), idx, g_nofranks, g_searchmode);
		});
		$("#fullscreen").click(function(jd) {
			if (g_searchmode == 0) {
				g_searchmode = 1;
				g_nofranks = 1;
				document.getElementById('fullscreen').id = 'exitfullscreen';
			}
			else
			{
				g_searchmode = 0;
				g_nofranks = 4;
				document.getElementById('exitfullscreen').id = 'fullscreen';
			}
			$('#DidYouMeanList').hide();
			g_query = $('#searchtext').val();
			SearchQuery( g_query, g_startindex, g_nofranks, g_searchmode);
		});
		$("#concertlist").click(function(jd) {
			if (g_searchmode == 0) {
				g_searchmode = 2;
				g_nofranks = 20;
				document.getElementById('concertlist').id = 'exitconcertlist';
			}
			else
			{
				alert( "QUERY: " + g_query );
				g_searchmode = 0;
				g_nofranks = 4;
				document.getElementById('exitconcertlist').id = 'concertlist';
			}
			$('#DidYouMeanList').hide();
			SearchQuery( g_query, g_startindex, g_nofranks, g_searchmode);
		});
		$('#searchtext').bind('keydown', function search(event) {
			if(event.keyCode == 13/*ENTER*/) {
				$('#DidYouMeanList').hide();
				g_query = $('#searchtext').val();
				SearchQuery( g_query, 0, g_nofranks, g_searchmode);
			}
		});
		$('#DidYouMeanList').bind('keydown', function search(event) {
			if(event.keyCode == 13/*ENTER*/) {
				$('#DidYouMeanList').hide();
				g_query = $(event.target).text();
				SearchQuery( g_query, 0, g_nofranks, g_searchmode);
			}
		});
		$('#searchtext').bind('input', function() {
			submitDidYouMeanQuery( $('#searchtext').val());
		});
		document.addEventListener( 'touchend', function(event) {
			if (event.target.matches('.dymelem')) {
				$('#DidYouMeanList').hide();
				g_query = $(event.target).text();
				SearchQuery( g_query, 0, g_nofranks, g_searchmode);
			}
			else {
				$('#DidYouMeanList').hide();
			}
		});
		document.addEventListener( 'click', function(event) {
			if (event.target.matches('.dymelem')) {
				$('#DidYouMeanList').hide();
				g_query = $(event.target).text();
				SearchQuery( g_query, 0, g_nofranks, g_searchmode);
			}
			else {
				$('#DidYouMeanList').hide();
			}
		});
	});
</script>
</head>
<body>
<div id="content">
<div id="searchfield">
	<input type = "text" id = "searchtext" tabindex="0"/>
	<input type = "button" id = "searchsubmit" tabindex="-1"/>
	<input type = "button" id = "searchnext" tabindex="-1"/>
	<input type = "button" id = "searchprev" tabindex="-1"/>
	<input type = "button" id = "fullscreen" tabindex="0"/>
	<input type = "button" id = "concertlist" tabindex="0"/>
	<div id="DidYouMean">
		<div id="DidYouMeanList"></div>
	</div>
</div>
<div id="searchresult">
	<div id="ranklist"></div>
</div>
</div>
</body>
</html>
